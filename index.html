<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H Project Brand | Project Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1.5rem;
        }
        @media (min-width: 1024px) {
            .kanban-board {
                grid-template-columns: repeat(5, 1fr);
            }
        }
        .kanban-column {
            background-color: #f4f5f7;
            border-radius: 0.5rem;
            padding: 1rem;
            width: 100%;
            flex-shrink: 0;
        }
        .kanban-column-future {
            background-color: #f0f9ff; /* Light blue */
        }
        .kanban-column-long-term {
            background-color: #fdf4ff; /* Light purple */
        }
        .task {
            position: relative;
            background-color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.3s, opacity 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border-left: 5px solid transparent; /* For priority */
        }
        .task.priority-low { border-left-color: #34d399; }
        .task.priority-medium { border-left-color: #f59e0b; }
        .task.priority-high { border-left-color: #ef4444; }
        .task-content {
            margin-bottom: 0.5rem;
            word-wrap: break-word;
        }
        .task-extra-info {
            font-size: 0.875rem;
            color: #4b5563;
            background-color: #f9fafb;
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
            border-left: 3px solid #6b7280;
            white-space: pre-wrap;
        }
        .task-content[contenteditable="true"] {
            outline: 2px solid #3b82f6;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .task-actions {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .task:hover .task-actions {
            opacity: 1;
        }
        .task-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            color: #6b7280;
            border-radius: 99px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .task-action-btn:hover {
            color: #1f2937;
            background-color: #e5e7eb;
        }
        .task-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 0.75rem;
        }
        .task-tag {
            background-color: #e5e7eb;
            color: #4b5563;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
        }
        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
        }
        .task-due-date {
            font-size: 0.75rem;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .task-due-date.overdue {
            color: #ef4444;
            font-weight: 600;
        }
        .task-timestamp {
            font-size: 0.75rem;
            color: #6b7280;
        }
        .task-assignee {
            width: 24px;
            height: 24px;
            border-radius: 9999px;
            background-color: #d1d5db;
            color: #1f2937;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        .task:active {
            cursor: grabbing;
            transform: scale(1.05);
        }
        .task.highlighted {
            animation: pulse-glow 2s ease-in-out 2;
            box-shadow: 0 0 15px 5px rgba(168, 85, 247, 0.6); /* Purple glow */
        }
        @keyframes pulse-glow {
            0% { transform: scale(1); box-shadow: 0 0 5px 2px rgba(168, 85, 247, 0.4); }
            50% { transform: scale(1.03); box-shadow: 0 0 15px 5px rgba(168, 85, 247, 0.7); }
            100% { transform: scale(1); box-shadow: 0 0 5px 2px rgba(168, 85, 247, 0.4); }
        }
        .task-list {
            min-height: 100px;
            padding-bottom: 1rem;
        }
        .dragging-over {
            background-color: #e9eaf0;
            border: 2px dashed #a0aec0;
        }
        #confetti-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 100;
        }
        .filter-btn {
            background-color: #fff; color: #4b5563; font-size: 0.875rem; font-weight: 500;
            padding: 0.25rem 0.75rem; border-radius: 9999px; border: 1px solid #d1d5db;
            cursor: pointer; transition: all 0.2s;
        }
        .filter-btn:hover { background-color: #f3f4f6; }
        .filter-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .task.hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Project Selection Screen -->
    <div id="project-selection-screen" class="min-h-screen flex items-center justify-center bg-gray-200">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg text-center">
            <div>
                <img id="logoImage" src="Gray & Sand Geometric Project Letter P Logo.png" alt="H Project Brand Logo" class="w-24 h-24 mx-auto mb-4">
                <h1 class="text-3xl font-bold text-gray-800">H Project Brand</h1>
                <p class="text-gray-500 mt-2">Your All-in-One Project Dashboard</p>
            </div>
            
            <form id="newProjectForm" class="space-y-4">
                 <div>
                    <label for="newProjectName" class="sr-only">New Project Name</label>
                    <input type="text" id="newProjectName" placeholder="Create a New Project..." class="w-full px-4 py-2 text-gray-700 bg-gray-100 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors">Create Project</button>
            </form>

            <div class="relative flex py-3 items-center">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="flex-shrink mx-4 text-gray-500">Or</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>
            
            <div class="space-y-4">
                 <h2 class="text-lg font-semibold text-gray-700">Select an Existing Project</h2>
                 <div id="projectListContainer" class="space-y-2">
                    <!-- Project list will be populated here -->
                 </div>
            </div>
        </div>
    </div>
    
    <!-- Main Dashboard -->
    <div id="main-dashboard" class="hidden">
        <canvas id="confetti-canvas"></canvas>
        <div class="container mx-auto p-4 md:p-8">
            <header class="text-center mb-8 relative">
                <input type="file" id="logoUpload" class="hidden" accept="image/*">
                <h1 id="main-dashboard-title" class="text-4xl font-bold text-gray-700">Project Dashboard</h1>
                
                <!-- Project Switcher Dropdown -->
                <div class="absolute top-0 right-0">
                    <select id="projectSwitcher" class="p-2 border border-gray-300 rounded-md">
                        <!-- Options populated by script -->
                    </select>
                </div>

                <div id="datetime-container" class="text-gray-500 mt-2 text-sm"></div>
                <p class="text-gray-500 mt-2">Organize your workflow, ideas, and finances in one place.</p>
            </header>

            <!-- Budget Tracker UI, Analytics, Team Hub etc. -->
            <div id="budget-tracker" class="mb-8 p-6 bg-white rounded-lg shadow-md">
            <div class="flex justify-between items-start">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">Budget Overview</h2>
                <button id="getFinancialInsightsBtn" class="bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-teal-600 transition-colors flex items-center gap-2">
                    âœ¨ Get Financial Insights
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                <div>
                    <p class="text-sm text-gray-500">Total Budget</p>
                    <p id="totalBudget" class="text-2xl font-semibold text-green-600">PKR 0.00</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Total Expenses</p>
                    <p id="totalExpenses" class="text-2xl font-semibold text-red-600">PKR 0.00</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Remaining</p>
                    <p id="remainingBudget" class="text-2xl font-semibold text-blue-600">PKR 0.00</p>
                </div>
            </div>
            <div class="text-center mt-4">
                 <button id="addTransactionBtn" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-indigo-600 transition-colors">Add Transaction</button>
            </div>
        </div>
        
        <div id="analytics-dashboard" class="mb-8 p-6 bg-white rounded-lg shadow-md">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-2xl font-bold text-gray-700">Analytics Dashboard</h2>
                <button id="generateReportBtn" class="bg-cyan-500 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-cyan-600 transition-colors flex items-center gap-2">
                    âœ¨ Generate Weekly Report
                </button>
            </div>
            <div class="w-full max-w-sm mx-auto">
                 <canvas id="tasksChart"></canvas>
            </div>
        </div>
        
        <div id="team-hub" class="mb-8 p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">ðŸ‘¥ Team Hub</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-600 mb-2">Add New Member</h3>
                    <form id="addTeamMemberForm" class="space-y-3">
                        <input type="text" id="newMemberName" placeholder="Name (Required)" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
                        <input type="tel" id="newMemberPhone" placeholder="Phone (Optional)" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <input type="email" id="newMemberEmail" placeholder="Email (Optional)" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <button type="submit" class="w-full bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-blue-600 transition-colors">Add Member</button>
                    </form>
                </div>
                <div>
                     <h3 class="text-lg font-semibold text-gray-600 mb-2">Current Team</h3>
                    <div id="teamMemberList" class="flex flex-wrap gap-2 items-center min-h-[50px] bg-gray-50 p-2 rounded-md">
                        <!-- Team members will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="flex justify-center items-center gap-4 mb-6 flex-wrap">
            <button id="addTaskBtn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300">Add New Task</button>
            <button id="prepareMeetingBtn" class="bg-green-500 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-green-600 transition-colors duration-300 flex items-center gap-2">âœ¨ Prepare Meeting</button>
             <button id="summaryBtn" class="bg-teal-500 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-teal-600 transition-colors duration-300 flex items-center gap-2">âœ¨ Generate Project Summary</button>
            <button id="notificationBtn" title="Enable Reminders" class="bg-white text-gray-600 p-2 rounded-full shadow-md hover:bg-gray-200 transition-colors duration-300"></button>
        </div>
        
        <div id="search-filter-container" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-white rounded-lg shadow">
             <input type="search" id="searchInput" placeholder="Search tasks..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
             <select id="priorityFilter" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <option value="all">All Priorities</option> <option value="high">High</option> <option value="medium">Medium</option> <option value="low">Low</option>
            </select>
             <select id="memberFilter" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <option value="all">All Members</option>
            </select>
        </div>
        <div id="filter-container" class="flex justify-center items-center gap-2 mb-6 flex-wrap px-4"></div>

        <div id="kanbanBoard" class="kanban-board">
            <div class="kanban-column" data-status="todo">
                <div class="flex justify-between items-center border-b-2 border-red-400 pb-2 mb-4">
                    <h2 class="text-lg font-semibold text-gray-600">To Do</h2>
                    <button id="suggestNextBtn" title="Let AI suggest your next task" class="text-purple-500 hover:text-purple-700 transition-colors p-1 rounded-full text-2xl leading-none">âœ¨</button>
                </div>
                <div class="task-list" data-status="todo"></div>
            </div>
            <div class="kanban-column" data-status="inprogress">
                <h2 class="text-lg font-semibold mb-4 text-center text-gray-600 border-b-2 border-yellow-400 pb-2">In Progress</h2>
                <div class="task-list" data-status="inprogress"></div>
            </div>
            <div class="kanban-column" data-status="done">
                <div class="flex justify-between items-center border-b-2 border-green-400 pb-2 mb-4">
                    <h2 class="text-lg font-semibold text-gray-600">Done</h2>
                    <button id="clearDoneBtn" title="Clear all completed tasks" class="text-gray-500 hover:text-red-600 transition-colors p-1 rounded-full hover:bg-red-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                </div>
                <div class="task-list" data-status="done"></div>
            </div>
            <div class="kanban-column kanban-column-future" data-status="future">
                <h2 class="text-lg font-semibold mb-4 text-center text-blue-600 border-b-2 border-blue-400 pb-2">Future Ideas</h2>
                <div class="task-list" data-status="future"></div>
            </div>
            <div class="kanban-column kanban-column-long-term" data-status="longterm">
                <h2 class="text-lg font-semibold mb-4 text-center text-purple-600 border-b-2 border-purple-400 pb-2">Long-Term Projects</h2>
                <div class="task-list" data-status="longterm"></div>
            </div>
        </div>
        
        <div id="budget-details" class="mt-8 p-6 bg-white rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-700">Budget Details</h2>
                <div class="flex gap-2">
                    <button id="exportBudgetCSV" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-700 transition-colors">Export CSV</button>
                    <button id="exportBudgetPDF" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-700 transition-colors">Export PDF</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-list" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
        
        <div id="business-analysis" class="mt-8 p-6 bg-white rounded-lg shadow-md">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-2xl font-bold text-gray-700">Business Analysis & Sales Tracking</h2>
                <button id="getBusinessAnalysisBtn" class="bg-rose-500 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-rose-600 transition-colors flex items-center gap-2">âœ¨ Get AI Business Analysis</button>
            </div>
             <div class="text-center mb-6">
                 <button id="addSaleBtn" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-green-600 transition-colors">Log Sale</button>
            </div>
            <div class="overflow-x-auto">
                 <h3 class="text-xl font-semibold text-gray-600 mb-2">Sales & Revenue</h3>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sales-list" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

        <div id="activity-stream" class="mt-8 p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">ðŸ“œ Activity Stream</h2>
            <div id="activityLogList" class="max-h-60 overflow-y-auto space-y-3 pr-2"></div>
        </div>

        <div id="settings-zone" class="mt-12 p-6 bg-red-50 border border-red-200 rounded-lg">
             <h2 class="text-xl font-bold text-red-800 mb-4">Settings & Data Management</h2>
             <p class="text-red-700 mb-4">Warning: The following action is irreversible and will delete all your tasks and budget data from this browser.</p>
             <button id="clearAllDataBtn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">Clear All Data</button>
        </div>
    </div>
    </div>

    <!-- MODALS -->
    <div id="meetingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">âœ¨ AI Meeting Preparation Assistant</h2>
            <form id="meetingForm">
                <div class="mb-4">
                    <label for="meetingObjective" class="block text-sm font-medium text-gray-700">Meeting Objective</label>
                    <textarea id="meetingObjective" rows="3" class="w-full mt-1 p-2 border border-gray-300 rounded-md" placeholder="e.g., Weekly sync to review progress on the Q4 marketing campaign." required></textarea>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700">Select Attendees</label>
                    <div id="meetingAttendees" class="mt-2 max-h-40 overflow-y-auto space-y-2 border border-gray-300 p-2 rounded-md">
                        <!-- Team members checklist will be populated here -->
                    </div>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancelMeetingBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">Generate Agenda</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Add a New Item</h2>
            <form id="taskForm">
                <div class="relative">
                    <textarea id="taskInput" class="w-full p-2 pr-10 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none" rows="3" placeholder="Enter a task, idea, or project..."></textarea>
                    <button type="button" id="suggestNameBtn" title="Suggest a better name with AI" class="absolute top-2 right-2 text-purple-500 hover:text-purple-700 transition-colors p-1 rounded-full text-2xl leading-none hidden">âœ¨</button>
                </div>
                 <div id="taskExtraInfoWrapper" class="mt-4 hidden">
                    <label for="taskExtraInfo" class="block text-sm font-medium text-gray-700">Additional Info</label>
                    <textarea id="taskExtraInfo" class="w-full mt-1 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none" rows="3" placeholder="Add details for your future idea..."></textarea>
                </div>
                 <div class="mt-4">
                    <label for="taskStatus" class="block text-sm font-medium text-gray-700">Add to</label>
                    <select id="taskStatus" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="todo" selected>To Do</option>
                        <option value="future">Future Ideas</option>
                        <option value="longterm">Long-Term Projects</option>
                    </select>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-4">
                    <div>
                        <label for="taskPriority" class="block text-sm font-medium text-gray-700">Priority</label>
                        <select id="taskPriority" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <option value="low">Low</option> <option value="medium" selected>Medium</option> <option value="high">High</option>
                        </select>
                    </div>
                    <div>
                        <label for="taskDueDate" class="block text-sm font-medium text-gray-700">Due Date</label>
                        <input type="date" id="taskDueDate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                 <div class="mt-4">
                    <label for="taskAssignee" class="block text-sm font-medium text-gray-700">Assign to</label>
                    <select id="taskAssignee" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        <option value="unassigned">Unassigned</option>
                    </select>
                </div>
                <div class="mt-6 flex justify-end gap-2 flex-wrap">
                    <button type="button" id="cancelBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Add Item</button>
                    <button type="button" id="breakdownBtn" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700 flex items-center gap-2">âœ¨ Add & Break Down</button>
                    <button type="button" id="assessRiskBtn" class="bg-amber-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-amber-600 flex items-center gap-2 mt-2 md:mt-0">âœ¨ Assess Risks</button>
                </div>
                 <div id="loadingIndicator" class="hidden text-center mt-4 text-gray-500"><p>ðŸ¤– AI is working...</p></div>
            </form>
        </div>
    </div>
    
    <div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Add Transaction</h2>
            <form id="transactionForm">
                <div>
                    <label for="transType" class="block text-sm font-medium text-gray-700">Type</label>
                    <select id="transType" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        <option value="income">Income</option> <option value="expense">Expense</option>
                    </select>
                </div>
                <div class="mt-4">
                    <label for="transDesc" class="block text-sm font-medium text-gray-700">Description</label>
                    <input type="text" id="transDesc" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                </div>
                <div class="mt-4">
                    <label for="transAmount" class="block text-sm font-medium text-gray-700">Amount</label>
                    <input type="number" id="transAmount" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" required min="0.01" step="0.01">
                </div>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="cancelTransBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600">Add</button>
                </div>
            </form>
        </div>
    </div>

    <div id="saleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Log a Sale</h2>
            <form id="saleForm">
                <div class="mt-4">
                    <label for="saleProduct" class="block text-sm font-medium text-gray-700">Product Name</label>
                    <input type="text" id="saleProduct" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                </div>
                 <div class="mt-4">
                    <label for="saleCategory" class="block text-sm font-medium text-gray-700">Product Category</label>
                    <input type="text" id="saleCategory" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" required>
                </div>
                <div class="mt-4">
                    <label for="saleAmount" class="block text-sm font-medium text-gray-700">Amount (PKR)</label>
                    <input type="number" id="saleAmount" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" required min="0.01" step="0.01">
                </div>
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="cancelSaleBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600">Log Sale</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="contactModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
             <div class="flex justify-between items-start mb-4">
                 <h2 class="text-2xl font-bold text-gray-800">Contact Details</h2>
                 <button id="closeContactModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="contactInfoContent" class="space-y-4 text-left"></div>
        </div>
    </div>

    <div id="aiHelpModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="aiHelpTitle" class="text-2xl font-bold">AI Assistant</h2>
                <button id="closeAiHelpBtn" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            </div>
            <div id="aiHelpContent" class="prose max-w-none overflow-y-auto"></div>
        </div>
    </div>

    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
            <h2 id="deleteModalTitle" class="text-xl font-bold mb-4">Are you sure?</h2>
            <p id="deleteModalText" class="text-gray-600 mb-6">Do you really want to delete this item? This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="cancelDeleteBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-400">Cancel</button>
                <button id="confirmDeleteBtn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Global State ---
            let currentProject = null;
            let projects = [];
            // Project-specific state
            let tasks = [];
            let transactions = [];
            let sales = [];
            let team = [];
            let activityLog = [];
            
            // Other state variables
            let draggedTaskId = null;
            let itemToDelete = { type: null, id: null };
            let reminderIntervalId = null;
            let activeFilterTag = null;
            let tasksChart = null;
            const { jsPDF } = window.jspdf;

            // --- Element Constants ---
            // Project Selection Screen
            const projectSelectionScreen = document.getElementById('project-selection-screen');
            const newProjectForm = document.getElementById('newProjectForm');
            const newProjectNameInput = document.getElementById('newProjectName');
            const projectListContainer = document.getElementById('projectListContainer');
            
            // Main Dashboard
            const mainDashboard = document.getElementById('main-dashboard');
            const mainDashboardTitle = document.getElementById('main-dashboard-title');
            const projectSwitcher = document.getElementById('projectSwitcher');
            
            // Other Elements
            const prepareMeetingBtn = document.getElementById('prepareMeetingBtn');
            const meetingModal = document.getElementById('meetingModal');
            const meetingForm = document.getElementById('meetingForm');
            const cancelMeetingBtn = document.getElementById('cancelMeetingBtn');
            const meetingAttendees = document.getElementById('meetingAttendees');
            const meetingObjective = document.getElementById('meetingObjective');
            const addTaskBtn = document.getElementById('addTaskBtn');
            const taskModal = document.getElementById('taskModal');
            const cancelBtn = document.getElementById('cancelBtn');
            const taskForm = document.getElementById('taskForm');
            const taskInput = document.getElementById('taskInput');
            const taskExtraInfoWrapper = document.getElementById('taskExtraInfoWrapper');
            const taskExtraInfo = document.getElementById('taskExtraInfo');
            const suggestNameBtn = document.getElementById('suggestNameBtn');
            const taskPriority = document.getElementById('taskPriority');
            const taskDueDate = document.getElementById('taskDueDate');
            const taskStatus = document.getElementById('taskStatus');
            const taskAssigneeEl = document.getElementById('taskAssignee');
            const kanbanBoard = document.getElementById('kanbanBoard');
            const confettiCanvas = document.getElementById('confetti-canvas');
            const confettiCtx = confettiCanvas.getContext('2d');
            const breakdownBtn = document.getElementById('breakdownBtn');
            const assessRiskBtn = document.getElementById('assessRiskBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const logoImage = document.getElementById('logoImage');
            const logoUpload = document.getElementById('logoUpload');
            const datetimeContainer = document.getElementById('datetime-container');
            const clearDoneBtn = document.getElementById('clearDoneBtn');
            const deleteModal = document.getElementById('deleteModal');
            const deleteModalTitle = document.getElementById('deleteModalTitle');
            const deleteModalText = document.getElementById('deleteModalText');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const summaryBtn = document.getElementById('summaryBtn');
            const aiHelpModal = document.getElementById('aiHelpModal');
            const aiHelpTitle = document.getElementById('aiHelpTitle');
            const aiHelpContent = document.getElementById('aiHelpContent');
            const closeAiHelpBtn = document.getElementById('closeAiHelpBtn');
            const filterContainer = document.getElementById('filter-container');
            const suggestNextBtn = document.getElementById('suggestNextBtn');
            const searchInput = document.getElementById('searchInput');
            const priorityFilter = document.getElementById('priorityFilter');
            const memberFilter = document.getElementById('memberFilter');
            const tasksChartCanvas = document.getElementById('tasksChart');
            const generateReportBtn = document.getElementById('generateReportBtn');
            const exportBudgetCSVBtn = document.getElementById('exportBudgetCSV');
            const exportBudgetPDFBtn = document.getElementById('exportBudgetPDF');
            const clearAllDataBtn = document.getElementById('clearAllDataBtn');
            const notificationBtn = document.getElementById('notificationBtn');
            const activityLogList = document.getElementById('activityLogList');
            const addTransactionBtn = document.getElementById('addTransactionBtn');
            const transactionModal = document.getElementById('transactionModal');
            const transactionForm = document.getElementById('transactionForm');
            const cancelTransBtn = document.getElementById('cancelTransBtn');
            const totalBudgetEl = document.getElementById('totalBudget');
            const totalExpensesEl = document.getElementById('totalExpenses');
            const remainingBudgetEl = document.getElementById('remainingBudget');
            const transactionListEl = document.getElementById('transaction-list');
            const getFinancialInsightsBtn = document.getElementById('getFinancialInsightsBtn');
            const addSaleBtn = document.getElementById('addSaleBtn');
            const saleModal = document.getElementById('saleModal');
            const saleForm = document.getElementById('saleForm');
            const cancelSaleBtn = document.getElementById('cancelSaleBtn');
            const salesListEl = document.getElementById('sales-list');
            const getBusinessAnalysisBtn = document.getElementById('getBusinessAnalysisBtn');
            const addTeamMemberForm = document.getElementById('addTeamMemberForm');
            const newMemberNameInput = document.getElementById('newMemberName');
            const newMemberPhoneInput = document.getElementById('newMemberPhone');
            const newMemberEmailInput = document.getElementById('newMemberEmail');
            const teamMemberList = document.getElementById('teamMemberList');
            const contactModal = document.getElementById('contactModal');
            const closeContactModalBtn = document.getElementById('closeContactModalBtn');
            const contactInfoContent = document.getElementById('contactInfoContent');

            // --- Project Management Functions ---
            const getProjects = () => JSON.parse(localStorage.getItem('h_project_brand_projects')) || [];
            const saveProjects = () => localStorage.setItem('h_project_brand_projects', JSON.stringify(projects));

            const loadDataForProject = (projectName) => {
                tasks = JSON.parse(localStorage.getItem(`project_${projectName}_tasks`)) || [];
                transactions = JSON.parse(localStorage.getItem(`project_${projectName}_transactions`)) || [];
                sales = JSON.parse(localStorage.getItem(`project_${projectName}_sales`)) || [];
                team = JSON.parse(localStorage.getItem(`project_${projectName}_team`)) || [];
                activityLog = JSON.parse(localStorage.getItem(`project_${projectName}_activityLog`)) || [];
            };

            const saveDataForProject = () => {
                if (!currentProject) return;
                localStorage.setItem(`project_${currentProject}_tasks`, JSON.stringify(tasks));
                localStorage.setItem(`project_${currentProject}_transactions`, JSON.stringify(transactions));
                localStorage.setItem(`project_${currentProject}_sales`, JSON.stringify(sales));
                localStorage.setItem(`project_${currentProject}_team`, JSON.stringify(team));
                localStorage.setItem(`project_${currentProject}_activityLog`, JSON.stringify(activityLog));
            };
            
            const loadProjectDashboard = (projectName) => {
                currentProject = projectName;
                localStorage.setItem('h_project_brand_lastProject', projectName);
                
                projectSelectionScreen.classList.add('hidden');
                mainDashboard.classList.remove('hidden');

                mainDashboardTitle.textContent = `${projectName} Dashboard`;
                
                loadDataForProject(projectName);
                
                // Full re-render of the dashboard
                saveAndRender(); 
                renderBudget();
                renderSales();
                populateProjectSwitcher();
            };

            const populateProjectList = () => {
                projectListContainer.innerHTML = '';
                if (projects.length === 0) {
                    projectListContainer.innerHTML = `<p class="text-gray-500 italic">No projects created yet.</p>`;
                    return;
                }
                
                projects.forEach(projectName => {
                    const projectEl = document.createElement('div');
                    projectEl.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-md';
                    projectEl.innerHTML = `
                        <button class="select-project-btn font-semibold text-blue-600 hover:underline">${projectName}</button>
                        <button class="delete-project-btn text-red-500 hover:text-red-700 font-bold" title="Delete project">&times;</button>
                    `;
                    projectListContainer.appendChild(projectEl);

                    projectEl.querySelector('.select-project-btn').addEventListener('click', () => loadProjectDashboard(projectName));
                    projectEl.querySelector('.delete-project-btn').addEventListener('click', () => {
                        showDeleteModal({ type: 'project', name: projectName });
                    });
                });
            };

            const populateProjectSwitcher = () => {
                projectSwitcher.innerHTML = '';
                projects.forEach(projectName => {
                    const option = document.createElement('option');
                    option.value = projectName;
                    option.textContent = projectName;
                    if (projectName === currentProject) {
                        option.selected = true;
                    }
                    projectSwitcher.appendChild(option);
                });
                const manageOption = document.createElement('option');
                manageOption.value = 'manage_projects';
                manageOption.textContent = 'â€¹ Manage Projects';
                projectSwitcher.appendChild(manageOption);
            };

            // --- SVG Icons, Activity Log, Date/Time, Logo, Notifications (same as before) ---
            const bellIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>`;
            const bellOffIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.73 21a2 2 0 0 1-3.46 0"></path><path d="M18.63 13A17.89 17.89 0 0 1 18 8"></path><path d="M6.26 6.26A5.86 5.86 0 0 0 6 8c0 7-3 9-3 9h14"></path><path d="M18 8a6 6 0 0 0-9.33-5.17"></path><path d="M1 1l22 22"></path></svg>`;
            const logActivity = (description) => {
                const newLog = { id: 'log-' + Date.now(), description: description, timestamp: new Date().toISOString() };
                activityLog.unshift(newLog);
                if (activityLog.length > 50) activityLog.pop();
                saveDataForProject();
                renderActivityLog();
            };
            const renderActivityLog = () => {
                activityLogList.innerHTML = '';
                if(activityLog.length === 0) {
                    activityLogList.innerHTML = `<p class="text-gray-500 italic">No activity yet for this project.</p>`;
                    return;
                }
                activityLog.forEach(log => {
                    const logEl = document.createElement('div');
                    logEl.className = 'text-sm text-gray-600 border-l-2 border-gray-200 pl-3';
                    const timeAgo = timeSince(new Date(log.timestamp));
                    logEl.innerHTML = `<p>${log.description}</p><p class="text-xs text-gray-400">${timeAgo}</p>`;
                    activityLogList.appendChild(logEl);
                });
            };
            const timeSince = (date) => {
                const seconds = Math.floor((new Date() - date) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + " years ago";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + " months ago";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + " days ago";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + " hours ago";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + " minutes ago";
                return "Just now";
            };
            const updateDateTime = () => {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
                datetimeContainer.textContent = now.toLocaleDateString('en-US', options);
            };
            const loadLogo = () => {
                const savedLogo = localStorage.getItem('h_project_brand_appLogo');
                if (savedLogo) {
                    logoImage.src = savedLogo;
                }
            };
            const updateNotificationButton = () => {
                if (!('Notification' in window)) { notificationBtn.style.display = 'none'; return; }
                switch (Notification.permission) {
                    case 'granted':
                        notificationBtn.innerHTML = bellIconSVG;
                        notificationBtn.title = 'Reminder notifications are enabled';
                        notificationBtn.classList.add('bg-green-100', 'text-green-700');
                        break;
                    case 'denied':
                        notificationBtn.innerHTML = bellOffIconSVG;
                        notificationBtn.title = 'Notifications are blocked.';
                        notificationBtn.classList.add('bg-red-100', 'text-red-700');
                        break;
                    default:
                        notificationBtn.innerHTML = bellOffIconSVG;
                        notificationBtn.title = 'Click to enable reminder notifications';
                        break;
                }
            };
            const handleNotificationClick = () => {
                if (!('Notification' in window)) return;
                if (Notification.permission === 'denied') { alert('Notifications are blocked. Please go to your browser settings to allow them.'); }
                else if (Notification.permission === 'default') {
                    Notification.requestPermission().then(permission => {
                        updateNotificationButton();
                        if (permission === 'granted') {
                            startReminderChecks();
                            new Notification('Notifications Enabled!', { body: 'You will now receive task reminders.' });
                        }
                    });
                }
            };
            const showNotification = (task) => {
                if (Notification.permission === 'granted') {
                    new Notification('Task Reminder', { body: `Your task is due today: "${task.text}"`, icon: logoImage.src, tag: task.id });
                }
            };
            const checkReminders = () => {
                const today = new Date().toISOString().split('T')[0];
                tasks.forEach(task => {
                    if (task.dueDate === today && task.status !== 'done' && !task.reminderSent) {
                        showNotification(task);
                        task.reminderSent = true;
                    }
                });
                saveDataForProject();
            };
            const startReminderChecks = () => {
                if (Notification.permission === 'granted' && !reminderIntervalId) {
                    checkReminders();
                    reminderIntervalId = setInterval(checkReminders, 60000);
                }
            };
            
            // --- Gemini API Call ---
            const generateTextWithGemini = async (userPrompt, systemPrompt, showLoadingInModal = false) => {
                if (showLoadingInModal) {
                    aiHelpContent.innerHTML = '<p>Generating insights...</p>';
                    aiHelpModal.classList.remove('hidden');
                }
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API call failed with status ${response.status}`);
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't generate a response.";
                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    return "Error: Could not get a response from the AI.";
                }
            };

            // --- AI Features ---
             const handlePrepareMeeting = async () => {
                const objective = meetingObjective.value.trim();
                if (!objective) {
                    alert('Please provide a meeting objective.');
                    return;
                }

                const selectedAttendeesCheckboxes = document.querySelectorAll('#meetingAttendees input[type="checkbox"]:checked');
                const attendees = Array.from(selectedAttendeesCheckboxes).map(cb => cb.dataset.name);

                aiHelpTitle.textContent = 'âœ¨ Generated Meeting Agenda';
                
                const overdueTasks = tasks.filter(t => t.dueDate && new Date(t.dueDate) < new Date() && t.status !== 'done');
                const inProgressTasks = tasks.filter(t => t.status === 'inprogress');
                const recentActivity = activityLog.slice(0, 5).map(log => `- ${log.description} (${timeSince(new Date(log.timestamp))})`);
                
                let promptData = `
                    Meeting Objective: ${objective}
                    Attendees: ${attendees.length > 0 ? attendees.join(', ') : 'N/A'}

                    Overdue Tasks (${overdueTasks.length}):
                    ${overdueTasks.length > 0 ? overdueTasks.map(t => `- "${t.text}" (Due: ${t.dueDate})`).join('\n') : 'None'}

                    Tasks Currently In Progress (${inProgressTasks.length}):
                    ${inProgressTasks.length > 0 ? inProgressTasks.map(t => `- "${t.text}"`).join('\n') : 'None'}
                    
                    Recent Project Activity (last 5 actions):
                    ${recentActivity.length > 0 ? recentActivity.join('\n') : 'None'}
                `;

                const systemPrompt = `You are an expert project manager and executive assistant. Your task is to generate a professional, structured, and actionable meeting agenda based on the provided project data. The agenda should be in markdown format. It should be concise and focused on driving the project forward. Start with the meeting objective, then create sections for key discussion points (like overdue items, progress review), and conclude with a section for new action items and open discussion.`;
                const userPrompt = `Please create a meeting agenda for project "${currentProject}" using the following project data:\n\n${promptData}`;
                
                const agenda = await generateTextWithGemini(userPrompt, systemPrompt, true);
                
                let htmlAgenda = agenda
                    .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold mb-3">$1</h1>')
                    .replace(/^## (.*$)/gim, '<h2 class="text-xl font-semibold mt-4 mb-2">$1</h2>')
                    .replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold mt-3 mb-1">$1</h3>')
                    .replace(/(\*|-|\+) (.*$)/gim, '<li>$2</li>')
                    .replace(/\n/g, '<br>');

                htmlAgenda = htmlAgenda.replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>').replace(/<\/ul><br><ul>/g, '');

                aiHelpContent.innerHTML = htmlAgenda;
                meetingModal.classList.add('hidden');
            };

            const handleAssessRisks = async () => { /* ... same logic ... */ };
            const handleGetBusinessAnalysis = async () => { /* ... same logic ... */ };
            const handleGenerateWeeklyReport = async () => { /* ... same logic ... */ };
            const handleGetFinancialInsights = async () => { /* ... same logic ... */ };
            const generateTagsForTask = async (task) => { /* ... same logic ... */ };
            const handleGetUnstuck = async (task) => { /* ... same logic ... */ };
            const handleGenerateSummary = async () => { /* ... same logic ... */ };
            const handleSuggestNextTask = async () => { /* ... same logic ... */ };
            const handleSuggestName = async () => { /* ... same logic ... */ };
            
            // --- Analytics & Data Export (no changes) ---
            const renderAnalyticsChart = () => { /* ... same logic ... */ };
            const exportToCSV = (data, filename, headers) => { /* ... same logic ... */ };

            // --- Team, Task, Budget, Sales Rendering ---
            const populateMeetingAttendees = () => {
                meetingAttendees.innerHTML = '';
                 if(team.length === 0) {
                    meetingAttendees.innerHTML = `<p class="text-gray-500 italic">No team members to select.</p>`;
                    return;
                }
                team.forEach(member => {
                    const attendeeEl = document.createElement('div');
                    attendeeEl.className = 'flex items-center';
                    attendeeEl.innerHTML = `
                        <input id="attendee-${member.id}" type="checkbox" data-name="${member.name}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="attendee-${member.id}" class="ml-2 block text-sm text-gray-900">${member.name}</label>
                    `;
                    meetingAttendees.appendChild(attendeeEl);
                });
            };
            const renderTeam = () => { /* ... same logic ... */ };
            const showContactModal = (member) => { /* ... same logic ... */ };
            const renderFilterTags = () => { /* ... same logic ... */ };
            const filterAndRenderTasks = () => { /* ... same logic ... */ };
            const getInitials = (name) => { /* ... same logic ... */ };
            const createTaskElement = (task) => { /* ... same logic ... */ };
            const saveAndRender = () => { /* ... same logic ... */ };
            const handleEditTask = (task, contentElement) => { /* ... same logic ... */ };
            const showDeleteModal = (item) => { /* ... same logic ... */ };
            const hideDeleteModal = () => { /* ... same logic ... */ };
            const formatCurrency = (amount) => new Intl.NumberFormat('en-PK', { style: 'currency', currency: 'PKR' }).format(amount);
            const renderBudget = () => { /* ... same logic ... */ };
            const renderSales = () => { /* ... same logic ... */ };

            // --- Drag & Drop, Confetti (no changes) ---
            const handleDragStart = (e) => { /* ... same logic ... */ };
            let confettiParticles = [];
            const triggerConfetti = () => { /* ... same logic ... */ };
            const animateConfetti = () => { /* ... same logic ... */ };
            
            // --- Event Listeners Setup ---
            const setupEventListeners = () => {
                newProjectForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const projectName = newProjectNameInput.value.trim();
                    if (projectName && !projects.includes(projectName)) {
                        projects.push(projectName);
                        saveProjects();
                        loadProjectDashboard(projectName);
                    } else if (projectName) {
                        alert(`Project "${projectName}" already exists.`);
                    }
                });

                projectSwitcher.addEventListener('change', () => {
                    const selectedValue = projectSwitcher.value;
                    if (selectedValue === 'manage_projects') {
                        currentProject = null;
                        mainDashboard.classList.add('hidden');
                        projectSelectionScreen.classList.remove('hidden');
                        populateProjectList();
                    } else {
                        loadProjectDashboard(selectedValue);
                    }
                });
                
                taskStatus.addEventListener('change', () => {
                    taskExtraInfoWrapper.classList.toggle('hidden', taskStatus.value !== 'future');
                });
                
                prepareMeetingBtn.addEventListener('click', () => {
                    populateMeetingAttendees();
                    meetingModal.classList.remove('hidden');
                });

                cancelMeetingBtn.addEventListener('click', () => {
                    meetingModal.classList.add('hidden');
                });

                meetingForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    handlePrepareMeeting();
                });

                // All other event listeners
                addTaskBtn.addEventListener('click', () => taskModal.classList.remove('hidden'));
                cancelBtn.addEventListener('click', () => taskModal.classList.add('hidden'));
                addTransactionBtn.addEventListener('click', () => transactionModal.classList.remove('hidden'));
                cancelTransBtn.addEventListener('click', () => transactionModal.classList.add('hidden'));
                addSaleBtn.addEventListener('click', () => saleModal.classList.remove('hidden'));
                cancelSaleBtn.addEventListener('click', () => saleModal.classList.add('hidden'));
                closeAiHelpBtn.addEventListener('click', () => aiHelpModal.classList.add('hidden'));
                closeContactModalBtn.addEventListener('click', () => contactModal.classList.add('hidden'));
                logoImage.addEventListener('click', () => logoUpload.click());
                logoUpload.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const logoDataUrl = e.target.result;
                            localStorage.setItem('h_project_brand_appLogo', logoDataUrl);
                            logoImage.src = logoDataUrl;
                        };
                        reader.readAsDataURL(file);
                    }
                });
                addTeamMemberForm.addEventListener('submit', (e) => { /* ... same logic ... */ });
                teamMemberList.addEventListener('click', (e) => { /* ... same logic ... */ });
                taskForm.addEventListener('submit', async (e) => { /* ... same logic ... */ });
                assessRiskBtn.addEventListener('click', handleAssessRisks);
                breakdownBtn.addEventListener('click', async () => { /* ... same logic ... */ });
                transactionForm.addEventListener('submit', (e) => { /* ... same logic, use saveDataForProject ... */ });
                saleForm.addEventListener('submit', (e) => { /* ... same logic, use saveDataForProject ... */ });
                kanbanBoard.addEventListener('dragend', (e) => { /* ... same logic ... */ });
                document.querySelectorAll('.task-list').forEach(list => { /* ... same logic ... */ });
                transactionListEl.addEventListener('click', (e) => { /* ... same logic ... */ });
                salesListEl.addEventListener('click', (e) => { /* ... same logic ... */ });
                confirmDeleteBtn.addEventListener('click', () => { /* ... same logic ... */ });
                searchInput.addEventListener('input', filterAndRenderTasks);
                priorityFilter.addEventListener('change', filterAndRenderTasks);
                memberFilter.addEventListener('change', filterAndRenderTasks);
                generateReportBtn.addEventListener('click', handleGenerateWeeklyReport);
                getBusinessAnalysisBtn.addEventListener('click', handleGetBusinessAnalysis);
                exportBudgetCSVBtn.addEventListener('click', () => { /* ... same logic ... */ });
                exportBudgetPDFBtn.addEventListener('click', () => { /* ... same logic ... */ });
                clearAllDataBtn.addEventListener('click', () => {
                    showDeleteModal({type: 'all'});
                    deleteModalText.textContent = `This will permanently erase all tasks, budget, and sales data for the "${currentProject}" project. This action cannot be undone.`;
                });
                getFinancialInsightsBtn.addEventListener('click', handleGetFinancialInsights);
                summaryBtn.addEventListener('click', handleGenerateSummary);
                suggestNextBtn.addEventListener('click', handleSuggestNextTask);
                suggestNameBtn.addEventListener('click', handleSuggestName);
                taskInput.addEventListener('input', () => suggestNameBtn.classList.toggle('hidden', taskInput.value.trim().length === 0));
                notificationBtn.addEventListener('click', handleNotificationClick);
                cancelDeleteBtn.addEventListener('click', hideDeleteModal);
                clearDoneBtn.addEventListener('click', () => { /* ... same logic ... */ });
            };
            
            // --- Initial Page Load ---
            const initializeApp = () => {
                projects = getProjects();
                const lastProject = localStorage.getItem('h_project_brand_lastProject');
                
                if (lastProject && projects.includes(lastProject)) {
                    loadProjectDashboard(lastProject);
                } else {
                    projectSelectionScreen.classList.remove('hidden');
                    mainDashboard.classList.add('hidden');
                    populateProjectList();
                }

                updateDateTime();
                setInterval(updateDateTime, 1000);
                loadLogo();
                updateNotificationButton();
                startReminderChecks();
                setupEventListeners();
            };

            initializeApp();
        });
    </script>
</body>
</html>

